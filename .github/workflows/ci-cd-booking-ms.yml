name: CI/CD - Booking MS 🛳️

on:
  push:
    branches: [master]

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Set up Java
      uses: actions/setup-java@v3
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Set up Maven
      uses: s4u/setup-maven-action@v1
      with:
        maven-version: 3.9.5

    # 🍕 NEW: Docker Installation & Group Setup
    - name: Install Docker (if needed) & Set Permissions
      run: |
        if ! command -v docker &> /dev/null; then
          echo "Docker not found. Installing Docker..."
          sudo yum update -y
          sudo yum install -y docker
          sudo systemctl enable docker
          sudo systemctl start docker
        else
          echo "Docker already installed ✅"
        fi

        echo "Adding $(whoami) to docker group"
        sudo usermod -aG docker $(whoami)

        echo "Granting current shell access to docker group"
        newgrp docker <<EONG
        docker version
EONG

    - name: Verify Docker Access
      run: docker info

    - name: Build with Maven
      run: mvn clean package

    - name: Log in to Docker Hub
      run: echo "${{ secrets.DOCKERHUB_PASS }}" | docker login -u "${{ secrets.DOCKERHUB_USER }}" --password-stdin

    - name: Build Docker image
      run: docker build -t chandan669/booking-ms:latest .

    - name: Push Docker image
      run: docker push chandan669/booking-ms:latest

